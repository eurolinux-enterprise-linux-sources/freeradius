From b564f606f9fdda0bc912d9ad70d04a7a5b07af48 Mon Sep 17 00:00:00 2001
From: "Alan T. DeKok" <aland@freeradius.org>
Date: Mon, 3 Jul 2017 14:48:47 -0400
Subject: [PATCH] FR-GV-203 - fix memory leak when using decode_tlv()

---
 src/lib/dhcp.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/src/lib/dhcp.c b/src/lib/dhcp.c
index 9f3aa79bb..6b520439e 100644
--- a/src/lib/dhcp.c
+++ b/src/lib/dhcp.c
@@ -478,12 +478,13 @@ static int decode_tlv(VALUE_PAIR *tlv, const uint8_t *data, size_t data_len)
 		}
 
 		if (fr_dhcp_attr2vp(vp, p + 2, p[1]) < 0) {
+			pairfree(&vp);
 			pairfree(&head);
 			goto make_tlv;
 		}
 
 		*tail = vp;
-		tail = &(vp->next);
+		while (*tail) tail = &((*tail)->next);
 		p += 2 + p[1];
 	}
 
-- 
2.13.2

